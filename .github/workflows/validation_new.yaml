name: Salesforce Data Import Pipeline - DEVCI

run-name: Workflow run PR No - ${{ github.event.pull_request.number }} and PR title - ${{ github.event.pull_request.title }} by @${{ github.actor }}

on:
  pull_request:
    branches:
      - main

    types:
      - opened
      - labeled

    labels:
      - 'Deploy Again'

jobs:
  Salesforce-Data-Import:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.list.outputs.files }}
    
    steps:
      # Checkout the current repository with all branches
      - id: CheckoutRepo
        name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: create test files
        run: |
          mkdir src
          mkdir src/AAA__c
          mkdir src/AAA__c/logs
          mkdir src/AAA__c/source
          mkdir src/AAA__c/target
          touch src/AAA__c/logs/1.log
          touch src/AAA__c/source/1.log
          touch src/AAA__c/target/1.log

          mkdir src/BBB__c
          mkdir src/BBB__c/logs
          mkdir src/BBB__c/source
          mkdir src/BBB__c/target
          touch src/BBB__c/logs/1.log
          touch src/BBB__c/source/1.log
          touch src/BBB__c/target/1.log

      - name: check files created
        run: |
          ls -lRa
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Instalar dependências
        run: npm install @actions/artifact

      # Check all modified folders and tar.gz the files if exist
      - name: Check all modified folders and tar.gz the files if exist
        id: compactFiles
        run: |
           cd src
           find . -mindepth 1 -maxdepth 1 -type d | while read -r folder; do
             echo "Processing folder: $folder"
             pwd
             ls -la
             cd "$folder"

             echo "Current directory: $(pwd)"
             echo "Listing files in current directory before SFDMU execution:"
             ls -la  

             OBJECT_NAME=$(basename "$folder")

             if [ -d "logs" ] || [ -d "source" ] || [ -d "target" ]; then
               echo "Checking if logs, source or target files exist"
               tar -czf ../$OBJECT_NAME.zip  logs source target
               node ../../upload-artifact.js ../$OBJECT_NAME.zip
             else
               echo "No logs, source or target files found."
             fi

             cd ..

           done

      - name: list `.zip` files
        run: |
          cd src
          ls -la *.zip || echo "file not found"

      - name: Listar arquivos para matriz
        id: list
        run: |
          files=$(ls src/*.zip | xargs -n 1 basename | jq -R -s -c 'split("\n")[:-1]')
          echo "Arquivos encontrados: $files"
          echo "files=$files" >> "$GITHUB_OUTPUT"

      - name: Upload dos arquivos para persistência entre jobs
        uses: actions/upload-artifact@v4
        with:
          name: temp-artifacts
          path: src/*.zip
  
  upload-files:
    needs: Salesforce-Data-Import
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.Salesforce-Data-Import.outputs.files) }}
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Baixar arquivos do job anterior
        uses: actions/download-artifact@v4
        with:
          name: temp-artifacts
          path: .

      - name: Listar arquivos baixados
        run: ls -l ./

      - name: Debug matrix files
        run: |
          echo "Matrix files: ${{ needs.Salesforce-Data-Import.outputs.files }}"
      
      - name: Upload de cada arquivo separadamente
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.file }}
          path: ${{ matrix.file }}
          retention-days: 7 

  cleanup:
    needs: upload-files  
    runs-on: ubuntu-latest
    steps:
      - name: Deletar os artifacts temporários imediatamente
        uses: geekyeggo/delete-artifact@v5
        with:
          name: temp-artifacts